<!-- Player Header -->
<app-header (tabChange)="setActiveTab($event)"></app-header>
<app-friend-requests></app-friend-requests>

@if (isDelegatedOrganizer && delegationStatus) {
<div class="delegation-status-banner">
  <div class="banner-content">
    <div class="delegation-info">
      <h3>ðŸ”„ Delegated Organizer Mode</h3>
      <p>
        You have delegated your organizer role to
        <strong>{{ getDelegateName() }}</strong> on {{ getDelegationDate() }}
      </p>
      @if (getDelegationNotes() !== 'No notes provided') {
      <p class="notes">
        <em>Notes: {{ getDelegationNotes() }}</em>
      </p>
      }
    </div>
    <div class="reclaim-section">
      <button
        class="reclaim-btn"
        (click)="showReclaimConfirmation()"
        [disabled]="isReclaimingRole"
      >
        @if (isReclaimingRole) {
        <span class="spinner"></span>
        }
        {{ isReclaimingRole ? "Reclaiming..." : "Reclaim My Organizer Role" }}
      </button>
    </div>
  </div>
</div>
}

<!-- Reclaim Confirmation Dialog -->
@if (showReclaimConfirmDialog) {
<div class="confirmation-dialog-overlay" (click)="cancelReclaim()">
  <div class="confirmation-dialog" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h3>Reclaim Organizer Role</h3>
    </div>
    <div class="dialog-body">
      <p>Are you sure you want to reclaim your organizer role?</p>
      <p>
        This will remove delegation from
        <strong>{{ getDelegateName() }}</strong> and they will no longer have
        organizer access.
      </p>
    </div>
    <div class="dialog-actions">
      <button
        class="btn-cancel"
        (click)="cancelReclaim()"
        [disabled]="isReclaimingRole"
      >
        Cancel
      </button>
      <button
        class="btn-confirm"
        (click)="reclaimOrganizerRole()"
        [disabled]="isReclaimingRole"
      >
        @if (isReclaimingRole) {
        <span>Processing...</span>
        } @else {
        <span>Yes, Reclaim Role</span>
        }
      </button>
    </div>
  </div>
</div>
}

<!-- Main Container -->
<div class="dashboard-container">
  <!-- Main Content Area -->
  <div class="main-content">
    <!-- My Matches Section - Always visible -->
    <div class="content-section">
      <h2>
        My Upcoming Matches @if (isDelegatedOrganizer) {
        <span class="player-mode-indicator">(Currently in Player Mode)</span>
        }
      </h2>
      <p class="subtitle">Matches you are enrolled in</p>
      @if (upcomingMatches.length === 0) {
      <div class="empty-state">
        You are not enrolled in any upcoming matches.
      </div>
      } @if (upcomingMatches.length > 0) {
      <div class="matches-table">
        <div class="table-header">
          <div class="col-team">Teams</div>
          <div class="col-date">Date</div>
          <div class="col-your-team">Your Team</div>
          <div class="col-price">Price per Player</div>
          <div class="col-action">Action</div>
        </div>

        @for (match of upcomingMatches; track match.id) {
        <div class="table-row">
          <div class="col-team">
            {{ match.teamAName }} vs {{ match.teamBName }}
          </div>
          <div class="col-date">
            {{ match.matchDate | date : "dd/MM/yyyy" }}
          </div>
          <div class="col-your-team">{{ getPlayerTeamName(match) }}</div>
          <div class="col-price">
            @if (match.cost && match.cost > 0) {
            <div class="price-breakdown">
              @if (match.status === 1 && getPriceInfo(match).exactPrice) {
              <div class="exact-price">
                <div class="price-option exact">
                  <strong>{{ getPriceInfo(match).exactPrice }} lei</strong>
                </div>
              </div>
              } @else {
              <div class="price-option">
                10 players:
                <strong>{{ getPriceInfo(match).for10 }} lei</strong>
              </div>
              <div class="price-option">
                11 players:
                <strong>{{ getPriceInfo(match).for11 }} lei</strong>
              </div>
              <div class="price-option">
                12 players:
                <strong>{{ getPriceInfo(match).for12 }} lei</strong>
              </div>
              }
            </div>
            } @else {
            <span class="free-match">FREE</span>
            }
          </div>
          <div class="col-action">
            <button class="action-btn" (click)="openPlayersModal(match)">
              View Teams
            </button>

            <button
              class="leave-btn"
              (click)="leaveMatch(match)"
              [title]="
                canLeaveMatch(match)
                  ? 'Leave Match'
                  : 'Added by organizer - cannot leave'
              "
              [disabled]="!canLeaveMatch(match)"
            >
              Leave Match
            </button>
          </div>
        </div>
        }
      </div>
      }
    </div>

    <!-- Regular Modal (View Teams) -->
    @if (modalOpen && modalType === 'view') {
    <div class="modal-backdrop" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <button class="close-modal-btn" (click)="closeModal()">Ã—</button>
        <h3>{{ selectedTeamAName }} vs {{ selectedTeamBName }}</h3>

        <div class="teams-container">
          <div class="team-list">
            <h4>{{ selectedTeamAName }}</h4>
            <ul>
              @for (player of selectedTeamAPlayers; track player) {
              <li>{{ player }}</li>
              }
            </ul>
          </div>
          <div class="vs-divider">VS</div>
          <div class="team-list">
            <h4>{{ selectedTeamBName }}</h4>
            <ul>
              @for (player of selectedTeamBPlayers; track player) {
              <li>{{ player }}</li>
              }
            </ul>
          </div>
        </div>
      </div>
    </div>
    }

    <!-- Join Match Modal -->
    @if (modalOpen && modalType === 'join') {
    <div class="modal-backdrop" (click)="closeModal()">
      <div class="modal-content join-modal" (click)="$event.stopPropagation()">
        <button class="close-modal-btn" (click)="closeModal()">Ã—</button>
        <h3>Join Match: {{ selectedTeamAName }} vs {{ selectedTeamBName }}</h3>
        <p class="modal-subtitle">Choose which team to join</p>

        <div class="join-teams-container">
          <div
            class="join-team-card"
            (click)="joinTeam(selectedMatch?.teamAId || 0)"
          >
            <div class="team-header">
              <h4>{{ selectedTeamAName }}</h4>
              <span class="team-count"
                >{{ selectedTeamAPlayers.length }} players</span
              >
            </div>
            <div class="team-players">
              @for (player of selectedTeamAPlayers; track player) {
              <div class="player-item">
                {{ player }}
              </div>
              } @if (selectedTeamAPlayers.length === 0) {
              <div class="no-players">No players yet</div>
              }
            </div>
            <button class="join-team-btn">Join {{ selectedTeamAName }}</button>
          </div>

          <div class="vs-divider-join">VS</div>

          <div
            class="join-team-card"
            (click)="joinTeam(selectedMatch?.teamBId || 0)"
          >
            <div class="team-header">
              <h4>{{ selectedTeamBName }}</h4>
              <span class="team-count"
                >{{ selectedTeamBPlayers.length }} players</span
              >
            </div>
            <div class="team-players">
              @for (player of selectedTeamBPlayers; track player) {
              <div class="player-item">
                {{ player }}
              </div>
              } @if (selectedTeamBPlayers.length === 0) {
              <div class="no-players">No players yet</div>
              }
            </div>
            <button class="join-team-btn">Join {{ selectedTeamBName }}</button>
          </div>
        </div>
      </div>
    </div>
    }

    <!-- Leave Match Confirmation Modal -->
    <app-confirmation-modal
      [isVisible]="showLeaveMatchConfirmDialog"
      title="Leave Match Confirmation"
      [message]="getLeaveMatchMessage()"
      confirmText="Yes, Leave Match"
      (confirmed)="onLeaveMatchConfirm()"
      (cancelled)="onLeaveMatchCancel()"
    >
    </app-confirmation-modal>
  </div>
</div>

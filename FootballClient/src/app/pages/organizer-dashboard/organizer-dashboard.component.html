<app-header></app-header>
<app-friend-requests></app-friend-requests>

<div class="page">
  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button
      class="tab-btn"
      [class.active]="activeTab === 'matches'"
      (click)="activeTab = 'matches'"
    >
      Matches
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'players'"
      (click)="activeTab = 'players'"
    >
      Players
    </button>
  </div>

  <!-- Floating Actions - Organizer Only -->
  <div class="fab-stack">
    <button
      *ngIf="activeTab === 'matches'"
      class="fab primary"
      (click)="showCreateMatchModal = true"
      aria-label="Create new match"
    >
      <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
        <path
          d="M12 5v14M5 12h14"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
        />
      </svg>
    </button>

    <button
      class="fab primary"
      (click)="showAddModal = true"
      aria-label="Add new player"
    >
      <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
        <!-- Player icon -->
        <path
          d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
        />
        <circle
          cx="8.5"
          cy="7"
          r="4"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
        />
        <!-- Plus sign for adding -->
        <line
          x1="20"
          y1="8"
          x2="20"
          y2="14"
          stroke="currentColor"
          stroke-width="2"
        />
        <line
          x1="17"
          y1="11"
          x2="23"
          y2="11"
          stroke="currentColor"
          stroke-width="2"
        />
      </svg>
    </button>
  </div>

  <!-- Organizer Matches Table -->
  <div
    *ngIf="activeTab === 'matches'"
    class="table-wrapper"
    role="region"
    aria-label="Matches table"
    tabindex="0"
  >
    <table class="matches-table modern">
      <thead>
        <tr>
          <th>#</th>
          <th>Date & Time</th>
          <th>Teams</th>
          <th>Location</th>
          <th>Cost</th>
          <th>Status</th>
          <th>Public</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let match of matches; let i = index"
          class="row-anim"
          [style.animationDelay]="i * 40 + 'ms'"
        >
          <td>{{ i + 1 }}</td>
          <td>{{ match.matchDate | date : "short" }}</td>
          <td class="teams-cell">
            <div class="team-names">
              <span class="team-a">{{ match.teamAName || "TeamA" }}</span>
              <span class="vs">vs</span>
              <span class="team-b">{{ match.teamBName || "TeamB" }}</span>
            </div>
          </td>
          <td>{{ match.location || "TBD" }}</td>
          <td>{{ match.cost ? match.cost + " Lei total" : "Free" }}</td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(match.status)">
              {{ getStatusText(match.status) }}
            </span>
          </td>
          <td>
            <span
              class="public-badge"
              [class.public]="match.isPublic"
              [class.private]="!match.isPublic"
            >
              {{ match.isPublic ? "Public" : "Private" }}
            </span>
          </td>
          <td class="actions">
            <button
              class="action-btn add-players-btn"
              title="Add Players"
              (click)="openAddPlayersModal(match)"
            >
              Add Players
            </button>
            <button
              *ngIf="!match.isPublic"
              class="action-btn make-public-btn"
              title="Make Public"
              (click)="makeMatchPublic(match.id)"
            >
              Make Public
            </button>
            <button
              class="action-btn edit-btn"
              title="Edit Match"
              (click)="openEditMatchModal(match)"
            >
              Edit
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Players Table -->
  <div
    *ngIf="activeTab === 'players'"
    class="table-wrapper"
    role="region"
    aria-label="Players table"
    tabindex="0"
  >
    <table class="players-table modern">
      <thead>
        <tr>
          <th>#</th>
          <th>First name</th>
          <th>Last name</th>
          <th>Rating</th>
          <th>Individual Stats</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="
            let player of searchTerm.trim() ? filteredPlayers : players;
            let i = index
          "
          [class.disabled-player]="!isPlayerEnabled(player)"
          class="row-anim"
          [style.animationDelay]="i * 40 + 'ms'"
        >
          <td>{{ i + 1 }}</td>

          <ng-container
            *ngIf="editIndex === i && isPlayerEnabled(player); else viewMode"
          >
            <td><input type="text" [(ngModel)]="editedPlayer!.firstName" /></td>
            <td><input type="text" [(ngModel)]="editedPlayer!.lastName" /></td>
            <td>
              <input
                type="number"
                [(ngModel)]="editedPlayer!.rating"
                min="0"
                max="10000"
                step="0.1"
              />
            </td>
            <td>
              <div class="edit-stats">
                <div class="stat-edit-group">
                  <label>Speed:</label>
                  <select [(ngModel)]="editedPlayer!.speed">
                    <option value="1">Low</option>
                    <option value="2">Medium</option>
                    <option value="3">High</option>
                    <option value="4">Extreme</option>
                  </select>
                </div>
                <div class="stat-edit-group">
                  <label>Stamina:</label>
                  <select [(ngModel)]="editedPlayer!.stamina">
                    <option value="1">Low</option>
                    <option value="2">Medium</option>
                    <option value="3">High</option>
                    <option value="4">Extreme</option>
                  </select>
                </div>
                <div class="stat-edit-group">
                  <label>Errors:</label>
                  <select [(ngModel)]="editedPlayer!.errors">
                    <option value="1">Low</option>
                    <option value="2">Medium</option>
                    <option value="3">High</option>
                    <option value="4">Extreme</option>
                  </select>
                </div>
              </div>
            </td>
            <td><span class="status-badge enabled">Active</span></td>
            <td class="actions">
              <button
                class="action-btn save-btn"
                title="Save"
                (click)="editPlayer()"
              >
                Save
              </button>
              <button
                class="action-btn cancel-btn"
                title="Cancel"
                (click)="clearEditIndex()"
              >
                Cancel
              </button>
            </td>
          </ng-container>

          <ng-template #viewMode>
            <td>
              {{
                isPlayerEnabled(player)
                  ? player.firstName
                  : (player.firstName | slice : 0 : 3)
              }}
            </td>
            <td>
              {{
                isPlayerEnabled(player)
                  ? player.lastName
                  : (player.lastName | slice : 0 : 3)
              }}
            </td>
            <td>{{ player.rating | number : "1.0-2" }}</td>
            <td>
              <app-player-stats
                [speed]="player.speed || 2"
                [stamina]="player.stamina || 2"
                [errors]="player.errors || 2"
              ></app-player-stats>
            </td>
            <td>
              <span
                class="status-badge"
                [class.enabled]="isPlayerEnabled(player)"
              >
                {{ isPlayerEnabled(player) ? "Active" : "Inactive" }}
              </span>
            </td>
            <td class="actions">
              @if (isPlayerEnabled(player)) {
              <button
                class="action-btn edit-btn"
                title="Edit"
                (click)="setEditIndex(i)"
              >
                Edit
              </button>
              <button
                class="action-btn delete-btn"
                title="Disable"
                (click)="deletePlayer(player.id!)"
              >
                Disable
              </button>
              } @else {
              <button
                class="action-btn reactivate-btn"
                title="Reactivate"
                (click)="enablePlayer(player.id!)"
              >
                Reactivate
              </button>
              }
            </td>
          </ng-template>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Add Player Modal -->
  @if (showAddModal) {
  <div class="modal-backdrop" (click)="showAddModal = false">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <button
        class="close-modal-btn"
        (click)="showAddModal = false"
        title="Close"
      >
        &times;
      </button>
      <h3>Add New Player</h3>
      <p class="modal-subtitle">Add a new player to your team roster</p>

      <div class="grid two">
        <input
          type="text"
          placeholder="First Name *"
          [(ngModel)]="newPlayer.firstName"
        />
        <input
          type="text"
          placeholder="Last Name *"
          [(ngModel)]="newPlayer.lastName"
        />
      </div>

      <input type="email" placeholder="Email *" [(ngModel)]="newPlayer.email" />

      <input
        type="text"
        placeholder="Username *"
        [(ngModel)]="newPlayer.username"
      />

      <input
        type="number"
        placeholder="Rating (0-10000)"
        [(ngModel)]="newPlayer.rating"
        min="0"
        max="10000"
        step="1"
      />

      <div class="stats-controls">
        <h4>Individual Stats</h4>
        <div class="grid three">
          <div class="stat-control-group">
            <label>Speed:</label>
            <select [(ngModel)]="newPlayer.speed">
              <option value="1">Low ⚡</option>
              <option value="2" selected>Medium ⚡⚡</option>
              <option value="3">High ⚡⚡⚡</option>
              <option value="4">Extreme ⚡⚡⚡⚡</option>
            </select>
          </div>
          <div class="stat-control-group">
            <label>Stamina:</label>
            <select [(ngModel)]="newPlayer.stamina">
              <option value="1">Low 💪</option>
              <option value="2" selected>Medium 💪💪</option>
              <option value="3">High 💪💪💪</option>
              <option value="4">Extreme 💪💪💪💪</option>
            </select>
          </div>
          <div class="stat-control-group">
            <label>Error Rate:</label>
            <select [(ngModel)]="newPlayer.errors">
              <option value="1">Low ❌</option>
              <option value="2" selected>Medium ❌❌</option>
              <option value="3">High ❌❌❌</option>
              <option value="4">Extreme ❌❌❌❌</option>
            </select>
          </div>
        </div>
      </div>
      <!-- Messages -->
      <div *ngIf="playerErrorMessage" class="error-message">
        {{ playerErrorMessage }}
      </div>

      <div *ngIf="playerSuccessMessage" class="success-message">
        {{ playerSuccessMessage }}
      </div>

      <button
        class="primary-cta"
        (click)="addPlayer()"
        [disabled]="playerLoading"
      >
        <span *ngIf="playerLoading">Adding Player...</span>
        <span *ngIf="!playerLoading">Add Player</span>
      </button>
    </div>
  </div>
  }

  <!-- Create Match Modal -->
  @if (showCreateMatchModal) {
  <div class="modal-backdrop" (click)="showCreateMatchModal = false">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <button
        class="close-modal-btn"
        (click)="showCreateMatchModal = false"
        title="Close"
      >
        &times;
      </button>
      <h3>Create New Match</h3>

      <!-- Date & Time -->
      <div class="form-group">
        <label>Match Date & Time *</label>
        <input
          type="datetime-local"
          [(ngModel)]="newMatch.matchDate"
          [min]="getMinDateTime()"
          required
        />
      </div>

      <!-- Location -->
      <div class="form-group">
        <label>Location *</label>
        <input
          type="text"
          placeholder="e.g., Central Stadium, Synthetic Field..."
          [(ngModel)]="newMatch.location"
          required
        />
      </div>

      <!-- Cost -->
      <div class="form-group">
        <label>Total Match Cost (Lei)</label>
        <input
          type="number"
          placeholder="e.g., 300"
          [(ngModel)]="newMatch.cost"
          min="0"
          step="0.01"
        />
      </div>

      <!-- Team Names -->
      <div class="team-names-section">
        <div class="grid two">
          <div class="form-group">
            <label>Team A Name</label>
            <input
              type="text"
              placeholder="Leave empty for 'TeamA'"
              [(ngModel)]="newMatch.teamAName"
              maxlength="50"
            />
          </div>
          <div class="form-group">
            <label>Team B Name</label>
            <input
              type="text"
              placeholder="Leave empty for 'TeamB'"
              [(ngModel)]="newMatch.teamBName"
              maxlength="50"
            />
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div *ngIf="matchErrorMessage" class="error-message">
        {{ matchErrorMessage }}
      </div>

      <div *ngIf="matchSuccessMessage" class="success-message">
        {{ matchSuccessMessage }}
      </div>

      <button
        class="primary-cta"
        (click)="createMatch()"
        [disabled]="matchLoading"
      >
        <span *ngIf="matchLoading">Creating...</span>
        <span *ngIf="!matchLoading">Create Match</span>
      </button>
    </div>
  </div>
  }

  <!-- Edit Match Modal -->
  @if (showEditMatchModal) {
  <div class="modal-backdrop" (click)="showEditMatchModal = false">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <button
        class="close-modal-btn"
        (click)="showEditMatchModal = false"
        title="Close"
      >
        &times;
      </button>
      <h3>Edit Match</h3>

      <!-- Date & Time -->
      <div class="form-group">
        <label>Match Date & Time *</label>
        <input
          type="datetime-local"
          [(ngModel)]="editMatch.matchDate"
          [min]="getMinDateTime()"
          required
        />
      </div>

      <!-- Location -->
      <div class="form-group">
        <label>Location *</label>
        <input
          type="text"
          placeholder="e.g., Central Stadium, Synthetic Field..."
          [(ngModel)]="editMatch.location"
          required
        />
      </div>

      <!-- Cost -->
      <div class="form-group">
        <label>Total Match Cost (Lei)</label>
        <input
          type="number"
          placeholder="e.g., 300"
          [(ngModel)]="editMatch.cost"
          min="0"
          step="0.01"
        />
      </div>

      <!-- Team Names -->
      <div class="team-names-section">
        <div class="grid two">
          <div class="form-group">
            <label>Team A Name</label>
            <input
              type="text"
              placeholder="Team A"
              [(ngModel)]="editMatch.teamAName"
              maxlength="50"
            />
          </div>
          <div class="form-group">
            <label>Team B Name</label>
            <input
              type="text"
              placeholder="Team B"
              [(ngModel)]="editMatch.teamBName"
              maxlength="50"
            />
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div *ngIf="editMatchErrorMessage" class="error-message">
        {{ editMatchErrorMessage }}
      </div>

      <button
        class="primary-cta"
        (click)="updateMatch()"
        [disabled]="editMatchLoading"
      >
        <span *ngIf="editMatchLoading">Updating...</span>
        <span *ngIf="!editMatchLoading">Update Match</span>
      </button>
    </div>
  </div>
  }

  <!-- Add Players Modal -->
  @if (showAddPlayersModal) {
  <div class="modal-backdrop" (click)="closeAddPlayersModal()">
    <div
      class="modal-content glass add-players-modal"
      (click)="$event.stopPropagation()"
    >
      <button
        class="close-modal-btn"
        (click)="closeAddPlayersModal()"
        title="Close"
      >
        &times;
      </button>

      <h3>Add Players to Match</h3>
      <div class="match-info">
        <p>
          <strong
            >{{ selectedMatch?.teamAName || "TeamA" }} vs
            {{ selectedMatch?.teamBName || "TeamB" }}</strong
          >
        </p>
        <p>
          {{ selectedMatch?.matchDate | date : "short" }} -
          {{ selectedMatch?.location }}
        </p>
      </div>

      <div class="team-builder-layout">
        <!-- Available Players (Left) -->
        <div class="available-players-panel">
          <div class="panel-header">
            <h4><i class="icon-users"></i>Available Players</h4>
            <span class="players-count"
              >{{ availablePlayers.length }} players</span
            >
          </div>

          <div class="players-list-simple">
            <div
              *ngFor="let player of availablePlayers; let i = index"
              class="player-row-simple"
              [class.already-added]="isPlayerInAnyTeam(player)"
            >
              <div class="player-name-rating">
                <span class="name">{{ player.username }}</span>
                <span class="rating">({{ player.rating }})</span>
              </div>

              <div class="action-buttons">
                <button
                  class="add-btn team1-btn"
                  (click)="addPlayerToTeam(player, 'teamA')"
                  [disabled]="
                    isPlayerInAnyTeam(player) || teamAPlayers.length >= 6
                  "
                  title="Add to {{ selectedMatch?.teamAName || 'Team 1' }}"
                >
                  T1
                </button>
                <button
                  class="add-btn team2-btn"
                  (click)="addPlayerToTeam(player, 'teamB')"
                  [disabled]="
                    isPlayerInAnyTeam(player) || teamBPlayers.length >= 6
                  "
                  title="Add to {{ selectedMatch?.teamBName || 'Team 2' }}"
                >
                  T2
                </button>
              </div>
            </div>

            <div *ngIf="players.length === 0" class="empty-state">
              <i class="icon-users-empty"></i>
              <p>No players available</p>
            </div>
          </div>
        </div>

        <!-- Teams Display (Right) -->
        <div class="teams-panel">
          <div class="teams-container">
            <!-- Team 1 -->
            <div class="team-table">
              <div class="team-header">
                <h4>Team 1</h4>
                <div class="team-stats">
                  <span class="count">{{ teamAPlayers.length }}/6</span>
                </div>
              </div>

              <div class="team-players-simple">
                <div
                  *ngFor="let player of teamAPlayers; let i = index"
                  class="simple-player-row"
                >
                  <span class="player-name"
                    >{{ player.username }}({{ player.rating }})</span
                  >
                  <div class="player-actions">
                    <button
                      class="move-btn"
                      (click)="movePlayerToOtherTeam(player, 'teamA')"
                      title="Move to Team 2"
                      [disabled]="addingPlayers || teamBPlayers.length >= 6"
                    >
                      →
                    </button>
                    <button
                      class="remove-btn-simple"
                      (click)="removePlayerFromTeam(player, 'teamA')"
                      title="Remove from team"
                      [disabled]="addingPlayers"
                    >
                      ×
                    </button>
                  </div>
                </div>

                <!-- Empty slots -->
                <div
                  *ngFor="
                    let slot of getEmptySlots(teamAPlayers.length);
                    let i = index
                  "
                  class="empty-slot-simple"
                >
                  <span class="empty-text">Empty slot</span>
                </div>
              </div>
            </div>

            <!-- Team 2 -->
            <div class="team-table">
              <div class="team-header">
                <h4>Team 2</h4>
                <div class="team-stats">
                  <span class="count">{{ teamBPlayers.length }}/6</span>
                </div>
              </div>

              <div class="team-players-simple">
                <div
                  *ngFor="let player of teamBPlayers; let i = index"
                  class="simple-player-row"
                >
                  <span class="player-name"
                    >{{ player.username }} ({{ player.rating }})</span
                  >
                  <div class="player-actions">
                    <button
                      class="move-btn"
                      (click)="movePlayerToOtherTeam(player, 'teamB')"
                      title="Move to Team 1"
                      [disabled]="addingPlayers || teamAPlayers.length >= 6"
                    >
                      ←
                    </button>
                    <button
                      class="remove-btn-simple"
                      (click)="removePlayerFromTeam(player, 'teamB')"
                      title="Remove from team"
                      [disabled]="addingPlayers"
                    >
                      ×
                    </button>
                  </div>
                </div>

                <!-- Empty slots -->
                <div
                  *ngFor="
                    let slot of getEmptySlots(teamBPlayers.length);
                    let i = index
                  "
                  class="empty-slot-simple"
                >
                  <span class="empty-text">Empty slot</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div *ngIf="addPlayersErrorMessage" class="error-message">
        {{ addPlayersErrorMessage }}
      </div>

      <div *ngIf="addPlayersSuccessMessage" class="success-message">
        {{ addPlayersSuccessMessage }}
      </div>

      <!-- Actions -->
      <div class="modal-actions">
        <button class="btn btn-secondary" (click)="closeAddPlayersModal()">
          Close
        </button>
      </div>
    </div>
  </div>
  }
</div>

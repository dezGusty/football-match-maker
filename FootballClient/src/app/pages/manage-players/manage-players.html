<app-header></app-header>
<app-friend-requests></app-friend-requests>

<div class="page">
  <!-- Delegation Status -->
  @if (delegationStatus?.isDelegating && delegationStatus?.currentDelegation) {
  <div class="delegation-status-banner warning">
    <strong>‚ö†Ô∏è Role Delegated:</strong> 
    You have delegated your organizer role to <strong>{{ delegationStatus?.currentDelegation?.delegateUserName }}</strong>
    <button 
      class="reclaim-btn"
      (click)="reclaimOrganizerRole()"
      [disabled]="delegationLoading"
    >
      {{ delegationLoading ? 'Reclaiming...' : 'Reclaim Role' }}
    </button>
  </div>
  }

  @if (delegationStatus?.isDelegate && delegationStatus?.receivedDelegation) {
  <div class="delegation-status-banner info">
    <strong>üëë Acting as Organizer:</strong> 
    You are acting as organizer for <strong>{{ delegationStatus?.receivedDelegation?.originalOrganizerName }}</strong>
  </div>
  }

  <!-- Floating Actions -->
  <div class="fab-stack">
    <button
      class="fab primary"
      (click)="showAddModal = true"
      aria-label="Add new player"
    >
      <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
        <!-- Player icon -->
        <path
          d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
        />
        <circle
          cx="8.5"
          cy="7"
          r="4"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
        />
        <!-- Plus sign for adding -->
        <line
          x1="20"
          y1="8"
          x2="20"
          y2="14"
          stroke="currentColor"
          stroke-width="2"
        />
        <line
          x1="17"
          y1="11"
          x2="23"
          y2="11"
          stroke="currentColor"
          stroke-width="2"
        />
      </svg>
    </button>
  </div>

  <!-- Players Table -->
  <div
    class="table-wrapper"
    role="region"
    aria-label="Players table"
    tabindex="0"
  >
    <table class="players-table modern">
      <thead>
        <tr>
          <th>#</th>
          <th>First name</th>
          <th>Last name</th>
          <th>Rating</th>
          <th>Individual Stats</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="
            let player of searchTerm.trim() ? filteredPlayers : players;
            let i = index
          "
          [class.disabled-player]="!isPlayerEnabled(player)"
          class="row-anim"
          [style.animationDelay]="i * 40 + 'ms'"
        >
          <td>{{ i + 1 }}</td>

          <ng-container
            *ngIf="editIndex === i && isPlayerEnabled(player); else viewMode"
          >
            <td><input type="text" [(ngModel)]="editedPlayer!.firstName" /></td>
            <td><input type="text" [(ngModel)]="editedPlayer!.lastName" /></td>
            <td>
              <input
                type="number"
                [(ngModel)]="editedPlayer!.rating"
                min="0"
                max="10000"
                step="0.1"
              />
            </td>
            <td>
              <div class="edit-stats">
                <div class="stat-edit-group">
                  <label>Speed:</label>
                  <select [(ngModel)]="editedPlayer!.speed">
                    <option value="1">Low</option>
                    <option value="2">Medium</option>
                    <option value="3">High</option>
                    <option value="4">Extreme</option>
                  </select>
                </div>
                <div class="stat-edit-group">
                  <label>Stamina:</label>
                  <select [(ngModel)]="editedPlayer!.stamina">
                    <option value="1">Low</option>
                    <option value="2">Medium</option>
                    <option value="3">High</option>
                    <option value="4">Extreme</option>
                  </select>
                </div>
                <div class="stat-edit-group">
                  <label>Errors:</label>
                  <select [(ngModel)]="editedPlayer!.errors">
                    <option value="1">Low</option>
                    <option value="2">Medium</option>
                    <option value="3">High</option>
                    <option value="4">Extreme</option>
                  </select>
                </div>
              </div>
            </td>
            <td><span class="status-badge enabled">Active</span></td>
            <td class="actions">
              <button
                class="action-btn save-btn"
                title="Save"
                (click)="editPlayer()"
              >
                Save
              </button>
              <button
                class="action-btn cancel-btn"
                title="Cancel"
                (click)="clearEditIndex()"
              >
                Cancel
              </button>
            </td>
          </ng-container>

          <ng-template #viewMode>
            <td>
              {{
                isPlayerEnabled(player)
                  ? player.firstName
                  : (player.firstName | slice : 0 : 3)
              }}
            </td>
            <td>
              {{
                isPlayerEnabled(player)
                  ? player.lastName
                  : (player.lastName | slice : 0 : 3)
              }}
            </td>
            <td>{{ player.rating | number : "1.0-1" }}</td>
            <td>
              <app-player-stats
                [speed]="player.speed || 2"
                [stamina]="player.stamina || 2"
                [errors]="player.errors || 2"
              ></app-player-stats>
            </td>
            <td>
              <span
                class="status-badge"
                [class.enabled]="isPlayerEnabled(player)"
              >
                {{ isPlayerEnabled(player) ? "Active" : "Inactive" }}
              </span>
            </td>
           
<td class="actions">
  @if (isPlayerEnabled(player)) {
    <button
      class="action-btn edit-btn"
      title="Edit"
      (click)="setEditIndex(i)"
    >
      Edit
    </button>
    @if (canDelegateToPlayer(player)) {
    <button
      class="action-btn delegate-btn"
      title="Make Organizer"
      (click)="openDelegateModal(player)"
    >
      Make Organizer
    </button>
    }
  }
</td>
          </ng-template>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Add Player Modal -->
  @if (showAddModal) {
  <div class="modal-backdrop" (click)="showAddModal = false">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <button
        class="close-modal-btn"
        (click)="showAddModal = false"
        title="Close"
      >
        &times;
      </button>
      <h3>Add New Player</h3>
      <p class="modal-subtitle">Add a new player to your team roster</p>

      <div class="grid two">
        <input
          type="text"
          placeholder="First Name *"
          [(ngModel)]="newPlayer.firstName"
        />
        <input
          type="text"
          placeholder="Last Name *"
          [(ngModel)]="newPlayer.lastName"
        />
      </div>

      <input type="email" placeholder="Email *" [(ngModel)]="newPlayer.email" />

      <input
        type="text"
        placeholder="Username *"
        [(ngModel)]="newPlayer.username"
      />

      <input
        type="number"
        placeholder="Rating (0-10000)"
        [(ngModel)]="newPlayer.rating"
        min="0"
        max="10000"
        step="1"
      />

      <div class="stats-controls">
        <h4>Individual Stats</h4>
        <div class="grid three">
          <div class="stat-control-group">
            <label>Speed:</label>
            <select [(ngModel)]="newPlayer.speed">
              <option value="1">Low ‚ö°</option>
              <option value="2" selected>Medium ‚ö°‚ö°</option>
              <option value="3">High ‚ö°‚ö°‚ö°</option>
              <option value="4">Extreme ‚ö°‚ö°‚ö°‚ö°</option>
            </select>
          </div>
          <div class="stat-control-group">
            <label>Stamina:</label>
            <select [(ngModel)]="newPlayer.stamina">
              <option value="1">Low üí™</option>
              <option value="2" selected>Medium üí™üí™</option>
              <option value="3">High üí™üí™üí™</option>
              <option value="4">Extreme üí™üí™üí™üí™</option>
            </select>
          </div>
          <div class="stat-control-group">
            <label>Error Rate:</label>
            <select [(ngModel)]="newPlayer.errors">
              <option value="1">Low ‚ùå</option>
              <option value="2" selected>Medium ‚ùå‚ùå</option>
              <option value="3">High ‚ùå‚ùå‚ùå</option>
              <option value="4">Extreme ‚ùå‚ùå‚ùå‚ùå</option>
            </select>
          </div>
        </div>
      </div>
      <!-- Messages -->
      <div *ngIf="playerErrorMessage" class="error-message">
        {{ playerErrorMessage }}
      </div>

      <div *ngIf="playerSuccessMessage" class="success-message">
        {{ playerSuccessMessage }}
      </div>

      <button
        class="primary-cta"
        (click)="addPlayer()"
        [disabled]="playerLoading"
      >
        <span *ngIf="playerLoading">Adding Player...</span>
        <span *ngIf="!playerLoading">Add Player</span>
      </button>
    </div>
  </div>
  }

  <!-- Delegate Organizer Modal -->
  @if (showDelegateModal && selectedPlayerForDelegation) {
  <div class="modal-backdrop" (click)="closeDelegateModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <button
        class="close-modal-btn"
        (click)="closeDelegateModal()"
        title="Close"
      >
        &times;
      </button>
      <h3>Delegate Organizer Role</h3>
      <p class="modal-subtitle">
        Make <strong>{{ selectedPlayerForDelegation.firstName }} {{ selectedPlayerForDelegation.lastName }}</strong> 
        the temporary organizer
      </p>

      <div class="delegation-info">
        <div class="info-item">
          <strong>Player:</strong> 
          {{ selectedPlayerForDelegation.firstName }} {{ selectedPlayerForDelegation.lastName }}
        </div>
        <div class="info-item">
          <strong>Rating:</strong> 
          {{ selectedPlayerForDelegation.rating | number: "1.0-1" }}
        </div>
        <div class="info-item">
          <strong>Email:</strong> 
          {{ selectedPlayerForDelegation.email }}
        </div>
      </div>

      <div class="form-group">
        <label for="delegationNotes">Notes (Optional):</label>
        <textarea
          id="delegationNotes"
          [(ngModel)]="delegationNotes"
          placeholder="Add any notes about this delegation..."
          rows="3"
        ></textarea>
      </div>

      <div class="warning-message">
        <strong>‚ö†Ô∏è Important:</strong>
        <ul>
          <li>This player will have full organizer privileges temporarily</li>
          <li>They can manage matches, players, and team formations</li>
          <li>You can reclaim your role at any time</li>
          <li>Only one delegation can be active at a time</li>
        </ul>
      </div>

      <!-- Messages -->
      <div *ngIf="delegationErrorMessage" class="error-message">
        {{ delegationErrorMessage }}
      </div>

      <div *ngIf="delegationSuccessMessage" class="success-message">
        {{ delegationSuccessMessage }}
      </div>

      <div class="modal-actions">
        <button
          class="secondary-btn"
          (click)="closeDelegateModal()"
          [disabled]="delegationLoading"
        >
          Cancel
        </button>
        <button
          class="danger-btn"
          (click)="delegateToPlayer()"
          [disabled]="delegationLoading"
        >
          <span *ngIf="delegationLoading">Delegating...</span>
          <span *ngIf="!delegationLoading">Delegate Role</span>
        </button>
      </div>
    </div>
  </div>
  }
</div>
